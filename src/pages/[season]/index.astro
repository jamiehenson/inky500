---
import ConstructorCard from "../../components/ConstructorCard.astro";
import Layout from "../../layouts/Layout.astro";
import type {
  ConstructorName,
  RacerName,
  SeasonName,
  TrackName,
} from "../../types";
import { ChevronLeft } from "lucide-astro";
import { seasonRacers, drivers, tracks, results } from "@/data";
import { withBase } from "@/utils";
import StatusBadge from "@/components/StatusBadge.astro";
import Button from "@/components/ui/Button.astro";

export function getStaticPaths() {
  return Object.keys(results).map((season) => ({ params: { season } }));
}

type Winner = {
  name: string;
  nationality?: string;
  team: string;
  car: ConstructorName;
};

const { season } = Astro.params as { season: SeasonName };
const tracksData = Object.entries(results[season]).map((track) => {
  const trackData = tracks[track[0] as TrackName];

  if (!track[1]?.results) {
    return {
      name: trackData?.name ?? "unknown",
      location: trackData?.location ?? "unknown",
      countryCode: trackData?.countryCode ?? "gb",
      date: track[1]?.date,
    };
  }

  const winners: Winner[] = (Object.keys(track[1].results) as RacerName[])
    .slice(0, 3)
    .map((id) => {
      const racer = seasonRacers[season][id];

      return {
        name: drivers[id].name,
        nationality: drivers[id].countryCode,
        team: racer?.team ?? "unknown",
        car: racer?.otherTeams?.[track[0]]?.car || racer?.car || "unknown",
      };
    });

  return {
    name: trackData?.name ?? "unknown",
    location: trackData?.location ?? "unknown",
    link: `/${season}/${track[0]}`,
    countryCode: trackData?.countryCode ?? "gb",
    winners,
    date: track[1].date,
  };
});

const seasonTitle = `Season ${season[season.length - 1].toUpperCase()}`;
---

<Layout
  title={`Inky 500 | ${seasonTitle}`}
  description={`All the stats from ${seasonTitle} of the Inky 500 ðŸ”Ž`}
>
  <a href={withBase()} class="absolute">
    <Button variant="outline">
      <ChevronLeft className="h-4 w-4" aria-label="Back" />
      Seasons
    </Button>
  </a>
  <h1>
    Season {season[season.length - 1].toUpperCase()}
  </h1>
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
    {
      tracksData.map(
        (track, index) =>
          track && (
            <ConstructorCard
              title={track.name}
              index={index + 1}
              subtitle={[track.location, track.countryCode]}
              link={track.link}
              car={track.winners?.[0].car ?? "unknown"}
            >
              <div class="flex flex-col gap-2 mb-4">
                {track.winners ? (
                  <>
                    <p>ðŸ¥‡ {track.winners[0].name}</p>
                    <p>ðŸ¥ˆ {track.winners[1].name}</p>
                    <p>ðŸ¥‰ {track.winners[2].name}</p>
                  </>
                ) : null}
              </div>
              <StatusBadge
                status={track.winners ? "complete" : "upcoming"}
                date={track.date}
              />
            </ConstructorCard>
          )
      )
    }
  </div>
</Layout>
